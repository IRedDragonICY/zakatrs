name: Auto Release

on:
  push:
    branches: [main]
    paths-ignore:
      - '*.md'
      - 'docs/**'
      - '.github/ISSUE_TEMPLATE/**'

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  # ==========================================================================
  # Create release on every push to main
  # ==========================================================================
  release:
    name: Create Release
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get version from Cargo.toml
        id: version
        run: |
          VERSION=$(grep -m1 '^version' Cargo.toml | sed 's/.*"\(.*\)".*/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $VERSION"
      
      - name: Generate release info
        id: info
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)
          FULL_SHA=$(git rev-parse HEAD)
          DATE=$(date -u +"%Y-%m-%d")
          
          # Tag format: v1.3.1+abc1234
          TAG="v${{ steps.version.outputs.version }}+${SHORT_SHA}"
          
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "full_sha=$FULL_SHA" >> $GITHUB_OUTPUT
          echo "date=$DATE" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
      
      - name: Check if tag exists
        id: check
        run: |
          if git rev-parse "${{ steps.info.outputs.tag }}" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Generate Release Notes
        if: steps.check.outputs.exists == 'false'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          SHORT_SHA="${{ steps.info.outputs.short_sha }}"
          FULL_SHA="${{ steps.info.outputs.full_sha }}"
          DATE="${{ steps.info.outputs.date }}"
          
          # Get last release tag
          LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          # Generate changelog
          echo "## Release v${VERSION} (${SHORT_SHA})" > release_notes.md
          echo "" >> release_notes.md
          echo "**Date:** ${DATE}" >> release_notes.md
          echo "**Commit:** [\`${SHORT_SHA}\`](https://github.com/${{ github.repository }}/commit/${FULL_SHA})" >> release_notes.md
          echo "" >> release_notes.md
          echo "### Changes" >> release_notes.md
          echo "" >> release_notes.md
          
          if [ -n "$LAST_TAG" ]; then
            git log ${LAST_TAG}..HEAD --pretty=format:"- %s (%h)" >> release_notes.md
          else
            git log --pretty=format:"- %s (%h)" -20 >> release_notes.md
          fi
          
          echo "" >> release_notes.md
          echo "" >> release_notes.md
          echo "---" >> release_notes.md
          echo "" >> release_notes.md
          echo "### Installation" >> release_notes.md
          echo "" >> release_notes.md
          echo "**Rust (Cargo)**" >> release_notes.md
          echo '```toml' >> release_notes.md
          echo "[dependencies]" >> release_notes.md
          echo "zakat = \"${VERSION}\"" >> release_notes.md
          echo "zakat-core = \"${VERSION}\"" >> release_notes.md
          echo '```' >> release_notes.md
          echo "" >> release_notes.md
          echo "**Python (PyPI)**" >> release_notes.md
          echo '```bash' >> release_notes.md
          echo "pip install zakatrs" >> release_notes.md
          echo '```' >> release_notes.md
          echo "" >> release_notes.md
          echo "**JavaScript/TypeScript (NPM)**" >> release_notes.md
          echo '```bash' >> release_notes.md
          echo "npm install @islamic/zakat" >> release_notes.md
          echo '```' >> release_notes.md
          echo "" >> release_notes.md
          echo "**JSR**" >> release_notes.md
          echo '```bash' >> release_notes.md
          echo "npx jsr add @islam/zakat" >> release_notes.md
          echo '```' >> release_notes.md
          echo "" >> release_notes.md
          echo "**Dart/Flutter**" >> release_notes.md
          echo '```bash' >> release_notes.md
          echo "dart pub add zakat" >> release_notes.md
          echo '```' >> release_notes.md
          echo "" >> release_notes.md
          echo "**Go**" >> release_notes.md
          echo '```bash' >> release_notes.md
          echo "go get github.com/IRedDragonICY/zakatrs/zakat_go@${{ steps.info.outputs.tag }}" >> release_notes.md
          echo '```' >> release_notes.md
          echo "" >> release_notes.md
          echo "---" >> release_notes.md
          echo "" >> release_notes.md
          echo "### Documentation" >> release_notes.md
          echo "- [API Reference](https://docs.rs/zakat)" >> release_notes.md
          echo "- [Usage Guide](https://github.com/IRedDragonICY/zakatrs#usage)" >> release_notes.md
      
      - name: Create GitHub Release
        if: steps.check.outputs.exists == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.info.outputs.tag }}
          name: "v${{ steps.version.outputs.version }} (${{ steps.info.outputs.short_sha }})"
          body_path: release_notes.md
          draft: false
          prerelease: false
          make_latest: true
      
      - name: Summary
        run: |
          if [ "${{ steps.check.outputs.exists }}" == "true" ]; then
            echo "## Release Skipped" >> $GITHUB_STEP_SUMMARY
            echo "Tag ${{ steps.info.outputs.tag }} already exists." >> $GITHUB_STEP_SUMMARY
          else
            echo "## Release Created" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Version:** v${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Commit:** ${{ steps.info.outputs.short_sha }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Tag:** ${{ steps.info.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          fi
