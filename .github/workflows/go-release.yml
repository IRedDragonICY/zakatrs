name: Go Library Release

on:
  push:
    branches: [main]
    paths:
      - 'zakat-core/**'
      - 'zakat_go/**'
      - '.github/workflows/go-release.yml'
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.2.0)'
        required: false
        default: ''

env:
  CARGO_TERM_COLOR: always

jobs:
  # ==========================================================================
  # Build native libraries for all platforms
  # ==========================================================================
  build-native:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x64
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact: libzakat_core.so
            artifact_name: libzakat_core-linux-x64.so
          
          # macOS x64 (Intel)
          - os: macos-13
            target: x86_64-apple-darwin
            artifact: libzakat_core.dylib
            artifact_name: libzakat_core-macos-x64.dylib
          
          # macOS ARM64 (Apple Silicon)
          - os: macos-14
            target: aarch64-apple-darwin
            artifact: libzakat_core.dylib
            artifact_name: libzakat_core-macos-arm64.dylib
          
          # Windows x64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact: zakat_core.dll
            artifact_name: zakat_core-windows-x64.dll

    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      
      # Rust/Cargo cache
      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-${{ matrix.target }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.target }}-cargo-registry-
      
      - name: Cache Cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-${{ matrix.target }}-cargo-release-uniffi-${{ hashFiles('**/Cargo.lock') }}-${{ hashFiles('zakat-core/**/*.rs') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.target }}-cargo-release-uniffi-${{ hashFiles('**/Cargo.lock') }}-
            ${{ runner.os }}-${{ matrix.target }}-cargo-release-uniffi-
      
      - name: Build zakat-core (cdylib)
        run: |
          cd zakat-core
          cargo build --release --features uniffi --target ${{ matrix.target }}
      
      - name: Prepare artifact
        shell: bash
        run: |
          mkdir -p artifacts
          cp target/${{ matrix.target }}/release/${{ matrix.artifact }} artifacts/${{ matrix.artifact_name }}
      
      - name: Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.artifact_name }}
          path: artifacts/${{ matrix.artifact_name }}
          retention-days: 30

  # ==========================================================================
  # Generate Go bindings (runs once, linux)
  # ==========================================================================
  generate-bindings:
    name: Generate Go Bindings
    runs-on: ubuntu-latest
    needs: build-native
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true
          cache-dependency-path: zakat_go/go.sum
      
      - name: Download Linux library
        uses: actions/download-artifact@v4
        with:
          name: libzakat_core-linux-x64.so
          path: zakat_go/
      
      # Cache Go binaries
      - name: Cache Go bin
        uses: actions/cache@v4
        with:
          path: ~/go/bin
          key: ${{ runner.os }}-go-bin-uniffi-bindgen-go
      
      - name: Install uniffi-bindgen-go
        run: |
          # Try installing from the community fork that supports Go
          go install github.com/ArcticIcePak/uniffi-bindgen-go/bindgen@latest || \
          echo "uniffi-bindgen-go not available, bindings must be generated manually"
      
      - name: Generate bindings
        run: |
          # Check if uniffi-bindgen-go is available
          if command -v uniffi-bindgen-go &> /dev/null; then
            cd zakat_go
            uniffi-bindgen-go --library libzakat_core-linux-x64.so --out-dir .
          else
            echo "Skipping binding generation - tool not installed"
          fi
      
      - name: Run Go tests
        run: |
          cd zakat_go
          go mod tidy
          go test -v ./...
      
      - name: Upload Go package
        uses: actions/upload-artifact@v6
        with:
          name: zakat_go-package
          path: zakat_go/
          retention-days: 30

  # ==========================================================================
  # Create release with all artifacts
  # ==========================================================================
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-native, generate-bindings]
    if: github.event_name == 'release' || github.event_name == 'workflow_dispatch'
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts/
      
      - name: Prepare release package
        run: |
          mkdir -p release
          
          # Copy native libraries
          cp release-artifacts/libzakat_core-linux-x64.so/libzakat_core-linux-x64.so release/
          cp release-artifacts/libzakat_core-macos-x64.dylib/libzakat_core-macos-x64.dylib release/
          cp release-artifacts/libzakat_core-macos-arm64.dylib/libzakat_core-macos-arm64.dylib release/
          cp release-artifacts/zakat_core-windows-x64.dll/zakat_core-windows-x64.dll release/
          
          # Create checksums
          cd release
          sha256sum * > checksums.txt
          
          # Create install script
          cat > install.sh << 'EOF'
          #!/bin/bash
          set -e
          
          OS=$(uname -s | tr '[:upper:]' '[:lower:]')
          ARCH=$(uname -m)
          
          case "$OS-$ARCH" in
            linux-x86_64)
              LIB="libzakat_core-linux-x64.so"
              DEST="/usr/local/lib"
              ;;
            darwin-x86_64)
              LIB="libzakat_core-macos-x64.dylib"
              DEST="/usr/local/lib"
              ;;
            darwin-arm64)
              LIB="libzakat_core-macos-arm64.dylib"
              DEST="/usr/local/lib"
              ;;
            *)
              echo "Unsupported platform: $OS-$ARCH"
              exit 1
              ;;
          esac
          
          echo "Installing $LIB to $DEST..."
          sudo cp "$LIB" "$DEST/"
          sudo ldconfig 2>/dev/null || true
          echo "Done! You can now use: go get github.com/IRedDragonICY/zakatrs/zakat_go"
          EOF
          chmod +x install.sh
      
      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            echo "version=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          elif [ -n "${{ github.event.inputs.version }}" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=v$(date +%Y%m%d)-$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          fi
      
      - name: Create/Update Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: "Zakat Go Library ${{ steps.version.outputs.version }}"
          body: |
            ## Zakat Go Library
            
            Native libraries for the zakatrs Go bindings.
            
            ### Installation
            
            **Option 1: Quick Install (Linux/macOS)**
            ```sh
            curl -sSL https://github.com/IRedDragonICY/zakatrs/releases/download/${{ steps.version.outputs.version }}/install.sh | bash
            go get github.com/IRedDragonICY/zakatrs/zakat_go@${{ steps.version.outputs.version }}
            ```
            
            **Option 2: Manual Install**
            1. Download the library for your platform
            2. Copy to `/usr/local/lib` (Linux/macOS) or add to PATH (Windows)
            3. `go get github.com/IRedDragonICY/zakatrs/zakat_go`
            
            ### Platform Support
            | Platform | File |
            |----------|------|
            | Linux x64 | `libzakat_core-linux-x64.so` |
            | macOS x64 (Intel) | `libzakat_core-macos-x64.dylib` |
            | macOS ARM64 (Apple Silicon) | `libzakat_core-macos-arm64.dylib` |
            | Windows x64 | `zakat_core-windows-x64.dll` |
            
            ### Checksums
            See `checksums.txt` for SHA256 verification.
          files: |
            release/*
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, '-') }}

  # ==========================================================================
  # Nightly builds (on push to main)
  # ==========================================================================
  nightly-tag:
    name: Update Nightly Tag
    runs-on: ubuntu-latest
    needs: [build-native, generate-bindings]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts/
      
      - name: Prepare nightly package
        run: |
          mkdir -p release
          cp release-artifacts/libzakat_core-linux-x64.so/libzakat_core-linux-x64.so release/
          cp release-artifacts/libzakat_core-macos-x64.dylib/libzakat_core-macos-x64.dylib release/
          cp release-artifacts/libzakat_core-macos-arm64.dylib/libzakat_core-macos-arm64.dylib release/
          cp release-artifacts/zakat_core-windows-x64.dll/zakat_core-windows-x64.dll release/
          cd release && sha256sum * > checksums.txt
      
      - name: Update nightly release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: nightly
          name: "Nightly Build"
          body: |
            ## Nightly Build
            
            **Commit:** ${{ github.sha }}
            **Built:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
            
            **Warning:** This is an unstable nightly build. Use at your own risk.
            
            ```sh
            go get github.com/IRedDragonICY/zakatrs/zakat_go@${{ github.sha }}
            ```
          files: release/*
          prerelease: true
